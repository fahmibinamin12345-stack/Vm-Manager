#!/bin/bash
# SPARK Multi-VM Manager (Cyber-Red Edition v2.3)
set -uo pipefail

VM_DIR="$HOME/vms"
mkdir -p "$VM_DIR"

# ========================================================================
# Cyber Theme Colors
# ========================================================================
R='\033[0;31m'       # Red
BR='\033[1;31m'      # Bold Red
DARK='\033[0;90m'    # Dark Grey
NC='\033[0m'         # No Color

# ========================================================================
# UI & Header
# ========================================================================

get_stats() {
    local ram_usage=$(free -m | awk '/^Mem:/{print $3}')
    local ram_total=$(free -m | awk '/^Mem:/{print $2}')
    local cpu_load=$(uptime | awk -F'load average:' '{ print $2 }' | cut -d',' -f1 | xargs)
    echo -e "${DARK}HOST STATS: RAM ${BR}${ram_usage}/${ram_total}MB${NC} ${DARK}| CPU LOAD ${BR}${cpu_load}${NC}"
}

display_header() {
    clear
    echo -e "${BR}"
    cat << "EOF"
    ███████╗██████╗  █████╗ ██████╗ ██╗  ██╗
    ██╔════╝██╔══██╗██╔══██╗██╔══██╗██║ ██╔╝
    ███████╗██████╔╝███████║██████╔╝█████╔╝ 
    ╚════██║██╔═══╝ ██╔══██║██╔══██╗██╔═██╗ 
    ███████║██║     ██║  ██║██║  ██║██║  ██╗
    ╚══════╝╚═╝     ╚═╝  ╚═╝╚═╝  ╚═╝╚═╝  ╚═╝
    >> BARE-METAL KVM SPOOFING ENGINE <<
EOF
    get_stats
    echo -e "${DARK}--------------------------------------------------------${NC}"
}

print_status() {
    local type=$1
    local message=$2
    case $type in
        "INFO") echo -e "${DARK}[${NC}${BR}*${NC}${DARK}]${NC} $message" ;;
        "WARN") echo -e "${DARK}[${NC}${BR}!${NC}${DARK}]${NC} $message" ;;
        "ERROR") echo -e "${BR}[ERROR] $message${NC}" ;;
        "SUCCESS") echo -e "${DARK}[${NC}${BR}✓${NC}${DARK}]${NC} $message" ;;
    esac
}

# ========================================================================
# Core Functions
# ========================================================================

check_dependencies() {
    for dep in qemu-system-x86_64 wget cloud-localds qemu-img; do
        command -v "$dep" &>/dev/null || { print_status "ERROR" "$dep not found."; exit 1; }
    done
}

save_vm_config() {
    cat > "$VM_DIR/$VM_NAME.conf" <<EOF
VM_NAME="$VM_NAME"
OS_TYPE="$OS_TYPE"
HOSTNAME="$HOSTNAME"
USERNAME="$USERNAME"
PASSWORD="$PASSWORD"
DISK_SIZE="$DISK_SIZE"
MEMORY="$MEMORY"
CPUS="$CPUS"
CPU_MODEL="$CPU_MODEL"
SSH_PORT="$SSH_PORT"
GUI_MODE="$GUI_MODE"
IMG_FILE="$IMG_FILE"
SEED_FILE="$SEED_FILE"
EOF
}

load_vm_config() {
    local config_file="$VM_DIR/$1.conf"
    if [[ -f "$config_file" ]]; then
        source "$config_file"
        return 0
    fi
    return 1
}

# ========================================================================
# VM Operations
# ========================================================================

create_new_vm() {
    display_header
    print_status "INFO" "OS: Debian 12 (Stable)"
    
    local BASE_IMG="$VM_DIR/debian-12-base.qcow2"
    local IMG_URL="https://cloud.debian.org/images/cloud/bookworm/latest/debian-12-generic-amd64.qcow2"
    
    echo -en "${BR}VM Name: ${NC}"; read -r VM_NAME
    
    echo -e "  ${BR}1)${NC} host (Standard)"
    echo -e "  ${BR}2)${NC} Ryzen 9950x (AMD Spoof)"
    echo -e "  ${BR}3)${NC} Custom (Manual String)"
    echo -en "${BR}CPU Choice [1]: ${NC}"; read -r c
    case ${c:-1} in
        2) CPU_MODEL="Ryzen 9950x" ;;
        3) echo -en "${BR}Enter QEMU CPU string: ${NC}"; read -r CPU_MODEL ;;
        *) CPU_MODEL="host" ;;
    esac

    echo -en "${BR}Memory (MB) [2048]: ${NC}"; read -r MEMORY; MEMORY=${MEMORY:-2048}
    echo -en "${BR}CPUs [2]: ${NC}"; read -r CPUS; CPUS=${CPUS:-2}
    echo -en "${BR}SSH Port [2222]: ${NC}"; read -r SSH_PORT; SSH_PORT=${SSH_PORT:-2222}
    echo -en "${BR}Disk [20G]: ${NC}"; read -r DISK_SIZE; DISK_SIZE=${DISK_SIZE:-20G}
    echo -en "${BR}User [debian]: ${NC}"; read -r USERNAME; USERNAME=${USERNAME:-debian}
    echo -en "${BR}Pass: ${NC}"; read -rs PASSWORD; echo
    
    HOSTNAME="$VM_NAME"; GUI_MODE="false"; OS_TYPE="Debian"
    IMG_FILE="$VM_DIR/$VM_NAME.qcow2"; SEED_FILE="$VM_DIR/$VM_NAME-seed.iso"

    if [[ ! -f "$BASE_IMG" ]]; then
        print_status "INFO" "Downloading Base Image..."
        wget -q --show-progress "$IMG_URL" -O "$BASE_IMG"
    fi

    cp "$BASE_IMG" "$IMG_FILE"
    qemu-img resize "$IMG_FILE" "$DISK_SIZE"
    
    generate_seed
    save_vm_config
    print_status "SUCCESS" "Node $VM_NAME initialized."
    read -rp "Press Enter to return..."
}

generate_seed() {
    echo "local-hostname: $HOSTNAME" > meta-data
    cat > user-data <<EOF
#cloud-config
user: $USERNAME
password: $PASSWORD
chpasswd: { expire: False }
ssh_pwauth: True
sudo: ALL=(ALL) NOPASSWD:ALL
EOF
    cloud-localds "$SEED_FILE" user-data meta-data
    rm user-data meta-data
}

edit_vm_config() {
    local vm_name=$1
    if load_vm_config "$vm_name"; then
        while true; do
            display_header
            print_status "INFO" "Editing Node: $vm_name"
            echo -e "  ${BR}1)${NC} Memory: ${MEMORY}MB"
            echo -e "  ${BR}2)${NC} CPUs:   ${CPUS}"
            echo -e "  ${BR}3)${NC} Port:   ${SSH_PORT}"
            echo -e "  ${BR}4)${NC} CPU ID: ${CPU_MODEL}"
            echo -e "  ${BR}5)${NC} Save & Exit"
            echo -en "${BR}Field Serial: ${NC}"; read -r choice
            
            case $choice in
                1) echo -en "${BR}New Memory: ${NC}"; read -r MEMORY ;;
                2) echo -en "${BR}New CPU Count: ${NC}"; read -r CPUS ;;
                3) echo -en "${BR}New SSH Port: ${NC}"; read -r SSH_PORT ;;
                4) 
                    echo -e "  ${BR}1)${NC} host | ${BR}2)${NC} Ryzen 9950x | ${BR}3)${NC} Custom"
                    read -r c
                    [[ $c == "2" ]] && CPU_MODEL="Ryzen 9950x"
                    [[ $c == "3" ]] && { echo -en "String: "; read -r CPU_MODEL; }
                    [[ $c == "1" ]] && CPU_MODEL="host"
                    ;;
                5) save_vm_config; break ;;
            esac
        done
    fi
}

start_vm() {
    local vm_name=$1
    if load_vm_config "$vm_name"; then
        print_status "INFO" "Igniting $vm_name..."
        
        local CPU_FLAGS
        if [[ "$CPU_MODEL" == "Ryzen 9950x" ]]; then
            CPU_FLAGS="max,vendor=AuthenticAMD,model-id='AMD Ryzen 9 9950X 16-Core Processor',kvm=off,+topoext"
        elif [[ "$CPU_MODEL" != "host" ]]; then
            CPU_FLAGS="$CPU_MODEL,kvm=off"
        else
            CPU_FLAGS="host,kvm=off"
        fi

        local qemu_cmd=(
            qemu-system-x86_64 -enable-kvm -machine q35,accel=kvm -cpu "$CPU_FLAGS"
            -m "$MEMORY" -smp "$CPUS",cores="$CPUS",threads=1,sockets=1
            -drive "file=$IMG_FILE,format=qcow2,if=virtio"
            -drive "file=$SEED_FILE,format=raw,if=virtio"
            -netdev "user,id=n1,hostfwd=tcp::$SSH_PORT-:22"
            -device virtio-net-pci,netdev=n1 -device virtio-balloon-pci
            -object rng-random,filename=/dev/urandom,id=rng0 -device virtio-rng-pci,rng=rng0
        )

        [[ "$GUI_MODE" == "true" ]] && qemu_cmd+=(-vga virtio -display gtk) || qemu_cmd+=(-nographic -serial mon:stdio)

        "${qemu_cmd[@]}" || print_status "ERROR" "System Crash Detected."
        read -rp "Terminal session closed. Press Enter..."
    fi
}

# ========================================================================
# Main Menu
# ========================================================================

main_menu() {
    while true; do
        display_header
        local vms=()
        if ls "$VM_DIR"/*.conf &>/dev/null; then
            mapfile -t vms < <(ls "$VM_DIR"/*.conf | xargs -n1 basename -s .conf)
        fi
        
        if [ ${#vms[@]} -eq 0 ]; then 
            echo -e "  ${DARK}(No Nodes Detected)${NC}"
        else
            for i in "${!vms[@]}"; do 
                printf "  ${DARK}[${BR}%02d${DARK}]${NC} %s\n" "$((i+1))" "${vms[$i]}"
            done
        fi
        
        echo -e "${DARK}--------------------------------------------------------${NC}"
        echo -e "  ${BR}1${NC}) Create | ${BR}2${NC}) Start | ${BR}3${NC}) Edit | ${BR}4${NC}) Delete | ${BR}5${NC}) Quit"
        echo -en "${BR}Spark > ${NC}"; read -r a
        
        case $a in
            1) create_new_vm ;;
            2) echo -en "${BR}Node Serial: ${NC}"; read -r n; [[ -n "$n" ]] && start_vm "${vms[$((n-1))]}" ;;
            3) echo -en "${BR}Edit Serial: ${NC}"; read -r n; [[ -n "$n" ]] && edit_vm_config "${vms[$((n-1))]}" ;;
            4) echo -en "${BR}Delete Serial: ${NC}"; read -r n; [[ -n "$n" ]] && rm -f "$VM_DIR/${vms[$((n-1))]}"* ;;
            5) exit 0 ;;
            *) print_status "WARN" "Invalid Directive" ; sleep 1 ;;
        esac
    done
}

check_dependencies
main_menu
